<!DOCTYPE html>
<meta charset="utf-8">
<title>How To Infer Topology</title>
<style>

@import url(../style.css);

iframe {
  width: 960px;
  height: 500px;
  background: #fff;
  border: solid 1px #ddd;
}

</style>

<header>
  <aside>September 1, 2013</aside>
  <a href="../" rel="author">Mike Bostock</a>
</header>

<h1>How To Infer Topology</h1>

<p><iframe src="http://bl.ocks.org/mbostock/raw/6406992/6edb424f82d0dcd0e6400e3cde4a057309a322e2/" marginwidth="0" marginheight="10" style="height:520px;" scrolling="no"></iframe>

<aside><a href="http://bl.ocks.org/mbostock/6406992" target="_blank">bl.ocks.org/6406992</a></aside>

<p>As its name implies, <a href="https://github.com/mbostock/topojson">TopoJSON</a> is a <i>topological</i> data format: rather than represent each shape discretely, it tracks shared edges, such as the border between California and Nevada. The main benefit of the topology is that it improves <a href="../simplify/">shape simplification</a> by avoiding <a href="http://www.jasondavies.com/maps/simplify/">artifacts</a> caused by simplifying shapes independently. But it also enables applications like <a href="http://bl.ocks.org/mbostock/4180634">map coloring</a> and <a href="http://bl.ocks.org/mbostock/5707610">selective meshing</a>, and makes the format more compact by removing redundant coordinates.

<p>Because most geospatial data formats (other than <a href="http://indiemaps.com/blog/2009/02/e00parser-an-actionscript-3-parser-for-the-arcinfo-export-topological-gis-format/">E00</a>) are <a href="http://www.esri.com/news/arcuser/0401/topo.html">not topological</a>, you must typically create TopoJSON by <b>inferring the topology from geometry</b>. This article documents my implementation, partly for general interest and partly to help you debug conversion problems when using the <a href="https://github.com/mbostock/topojson/wiki/Command-Line-Reference"><code>topojson</code> command-line tool</a>. This can also serve as a guide should you be interested in implementing TopoJSON conversion in <a href="http://sgillies.net/blog/1159/topojson-with-python/">another</a> <a href="https://github.com/calvinmetcalf/topojson.py">language</a>.

<p>The algorithm has four steps:<ol>

<li><a href="#extract">extract</a> - decompose shapes into lines and rings.
<li><a href="#join">join</a> - identify junctions (intersection points).
<li><a href="#cut">cut</a> - split or rotate arcs to terminate at junctions.
<li><a href="#dedup">dedup</a> - consolidate duplicate arcs.
</ol>

Each step is implemented in a <a href="https://github.com/mbostock/topojson/tree/better-exact-topology/lib/topojson/topology">source file</a> of the same name, should you wish to follow along in the code.

<h2><a href="#extract" name="extract">#</a>1. Extract</h2>

<p>The minimum information needed to infer the topology is the set of all lines and rings extracted from the input geometry. This extraction simplifies the downstream logic; for example, the topology doesn’t care whether two polygons are represented as two Polygon geometries or one MultiPolygon geometry, as both are simply two rings.

<p>Extracting lines and rings is a straightforward decomposition of the input geometries: a LineString is converted to one line, a MultiLineString is converted to zero or more lines, a Polygon is converted to one or more rings, and so on. The algorithm must also record which lines and rings are associated with which input geometries, so that the geometry can be recomposed from the final topology when the conversion is complete.

<p>This animation demonstrates extraction on U.S. state borders:

<p><iframe src="http://bl.ocks.org/mbostock/raw/6408735/b885b26c44fe4911f6a7fdbdadc31ac23dd3ab9b/" marginwidth="0" marginheight="10" style="height:520px;" scrolling="no"></iframe>

<aside><a href="http://bl.ocks.org/mbostock/6408735" target="_blank">bl.ocks.org/6408735</a></aside>

<p>(Rings are colored randomly for visual separation.) The order of rings is arbitrary, though note that rings for each state are extracted together, since a state is typically represented as a MultiPolygon.

<p>Why differentiate between lines and rings? For topologies, rings are a special form of closed lines that can be rotated: the start of the ring can be changed to any point along the ring without violating the geometry. This special property can be used in <a href="#cut">step three</a> to reduce the number of arcs that need to be split, optimizing the topology.

<h2><a href="#join" name="join">#</a>2. Join</h2>

<p>The next step is to identify junctions: intersection points where two or more lines or rings meet. For example, consider the line <i>ABC</i>, where <i>A</i>, <i>B</i> and <i>C</i> are distinct points. If there is another line <i>DBE</i>, then <i>B</i> is a junction. Similarly, if there are two lines <i>ABC</i> and <i>ABD</i>, then because the lines diverge at point <i>B</i>, <i>B</i> is a junction. A few simple examples:

<p><iframe src="http://bl.ocks.org/mbostock/raw/6409154/cd1fd329b2add21f623a68cf8a1d3b16be054b44/" marginwidth="0" marginheight="0" style="height:240px;" scrolling="no"></iframe>

<aside><a href="http://bl.ocks.org/mbostock/6409154" target="_blank">bl.ocks.org/6409154</a></aside>

<p>Junctions are irrespective to order. So, given two lines <i>ABC</i> and <i>CBA</i>, then <i>B</i> is not a junction — unless there is some other line that intersects <i>B</i>. For the purposes of topology construction, we also consider the start and end point of every line to be a junction. This simplifies the code slightly, and has no detrimental effect because it is not necessary to cut a line at a given junction if the line already terminates at that junction.

<p>The junctions for the U.S. state borders can be seen here as black dots:

<p><iframe src="http://bl.ocks.org/mbostock/raw/6408918/e440132e3db9a0fa53e2d09ad83447aba4fd99fb/" marginwidth="0" marginheight="10" style="height:520px;" scrolling="no"></iframe>

<aside><a href="http://bl.ocks.org/mbostock/6408918" target="_blank">bl.ocks.org/6408918</a></aside>

<p>As you expect, the border intersection points in the interior of the contiguous United States are correctly identified as junctions. You can also see a few additional junctions on the coasts, such as on the Gulf of Mexico and Puget Sound. These junctions are caused by coastal features that are too small to see in the current map, such as adjacent islands that share a single point. Independent rings, such as the Hawaiian islands, have no junctions; this is because rings can be freely rotated without changing the geometry.

<aside>A <a href="https://github.com/mbostock/topojson/tree/better-exact-topology/lib/topojson/topology/hashtable.js">hashtable</a> is a reasonable way to record neighbors. However, note that the hashtable can be as large as the input geometry! <a href="http://en.wikipedia.org/wiki/Linear_probing">Linear probing</a> provides a noticeable performance improvement over array buckets.</aside>

<p>The process of identifying junctions requires iterating over each line and ring while recording the neighbors of each visited point. If a point is subsequently revisited and has a <i>different</i> set of neighbors than before, then the point is a junction. For example, given the two lines <i>ABC</i> and <i>ABD</i>, the first time we visit <i>B</i>, the neighbors are {<i>A</i>, <i>C</i>}. The second time we visit <i>B</i>, the new neighbors are {<i>A</i>, <i>D</i>}, which is different than before, and thus <i>B</i> is a junction.

<h2><a href="#cut" name="cut">#</a>3. Cut or Rotate</h2>

<p>…

<h2><a href="#dedup" name="dedup">#</a>4. Dedup</h2>

<p>…

<h2><a href="#quantization" name="quantization">#</a>Quantization</h2>

<p>…

<footer>
  <aside>September 1, 2013</aside>
  <a href="../" rel="author">Mike Bostock</a>
</footer>

<!-- <script src="http://d3js.org/d3.v3.min.js"></script> -->
<!-- <script src="http://d3js.org/topojson.v1.min.js"></script> -->
<!-- <script src="../highlight.min.js"></script> -->
